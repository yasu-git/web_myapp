name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # main ブランチにプッシュされたら実行
  pull_request:
    branches:
      - main

jobs:
  # フロントエンド (Vue.js) のビルド
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 メインリポジトリのコードを取得
        uses: actions/checkout@v3

      - name: 📥 フロントエンドリポジトリのコードを取得
        uses: actions/checkout@v3
        with:
          repository: yasu-git/vue-frontend  # Vueのリポジトリ
          path: vue-frontend  # `vue-frontend` にクローン

      - name: 📂 ディレクトリ構成を確認
        run: ls -la

      - name: 🔧 Node.js のセットアップ
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'  # `yarn` のキャッシュを利用

      - name: 📦 Yarn をインストール
        run: npm install -g yarn  # `yarn` をグローバルにインストール

      - name: 📦 依存関係をインストール
        run: |
          ls -la vue-frontend  # `vue-frontend` の中身を確認
          cd vue-frontend && yarn install

      - name: 🏗️ Vue.js をビルド
        run: |
          cd vue-frontend && yarn build

  # バックエンド (Go) のビルド
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 メインリポジトリのコードを取得
        uses: actions/checkout@v3

      - name: 📥 バックエンドリポジトリのコードを取得
        uses: actions/checkout@v3
        with:
          repository: yasu-git/web_myapp  # Goのリポジトリ
          path: web_myapp  # `web_myapp` にクローン

      - name: 📂 ディレクトリ構成を確認
        run: ls -la && ls -la web_myapp  # `web_myapp` があるか確認

      - name: 🔧 Go のセットアップ
        uses: actions/setup-go@v3
        with:
          go-version: '1.20'

      - name: 📦 依存関係をインストール
        run: |
          ls -la web_myapp  # `web_myapp` の中身を確認
          cd web_myapp && go mod tidy

      - name: ✅ Go のテストを実行
        run: |
          cd web_myapp && go test ./...

  # 🚀 デプロイ
  deploy:
    needs: [build-frontend, build-backend]  # フロントとバックのビルドが成功したら実行
    runs-on: ubuntu-latest
    steps:
      - name: 🔑 SSH の設定
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > deploy_key
          chmod 600 deploy_key

      - name: 🚀 サーバーへデプロイ
        run: |
          ssh -i deploy_key -o StrictHostKeyChecking=no user@${{ secrets.SERVER_IP }} /bin/bash -c "
            cd /home/user/myapp || exit 1
            git pull
            docker-compose ps  # 現在のコンテナの状態を確認
            docker-compose up -d --build"
