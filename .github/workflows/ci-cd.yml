name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # main ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚‰å®Ÿè¡Œ
  pull_request:
    branches:
      - main

jobs:
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vue.js) ã®ãƒ“ãƒ«ãƒ‰
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v3

      - name: ğŸ“¥ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v3
        with:
          repository: yasu-git/vue-frontend  # Vueã®ãƒªãƒã‚¸ãƒˆãƒª
          path: vue-frontend  # `vue-frontend` ã«ã‚¯ãƒ­ãƒ¼ãƒ³

      - name: ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’ç¢ºèª
        run: ls -la

      - name: ğŸ”§ Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'  # `yarn` ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨

      - name: ğŸ“¦ Yarn ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g yarn  # `yarn` ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          ls -la vue-frontend  # `vue-frontend` ã®ä¸­èº«ã‚’ç¢ºèª
          cd vue-frontend && yarn install

      - name: ğŸ—ï¸ Vue.js ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          cd vue-frontend && yarn build

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Go) ã®ãƒ“ãƒ«ãƒ‰
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v3

      - name: ğŸ“¥ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v3
        with:
          repository: yasu-git/web_myapp  # Goã®ãƒªãƒã‚¸ãƒˆãƒª
          path: web_myapp  # `web_myapp` ã«ã‚¯ãƒ­ãƒ¼ãƒ³

      - name: ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’ç¢ºèª
        run: ls -la && ls -la web_myapp  # `web_myapp` ãŒã‚ã‚‹ã‹ç¢ºèª

      - name: ğŸ”§ Go ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v3
        with:
          go-version: '1.20'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          ls -la web_myapp  # `web_myapp` ã®ä¸­èº«ã‚’ç¢ºèª
          cd web_myapp && go mod tidy

      - name: âœ… Go ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          cd web_myapp && go test ./...

  # ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    needs: [build-frontend, build-backend]  # ãƒ•ãƒ­ãƒ³ãƒˆã¨ãƒãƒƒã‚¯ã®ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ãŸã‚‰å®Ÿè¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”‘ SSH ã®è¨­å®š
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > deploy_key
          chmod 600 deploy_key

      - name: ğŸš€ ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          ssh -i deploy_key -o StrictHostKeyChecking=no user@${{ secrets.SERVER_IP }} /bin/bash -c "
            cd /home/user/myapp || exit 1
            git pull
            docker-compose ps  # ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèª
            docker-compose up -d --build"
